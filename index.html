<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- google font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=IBM+Plex+Sans+JP&family=Zen+Kaku+Gothic+New&family=Zen+Kurenaido&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
<!-- ここまで -->
<link rel="stylesheet" href="./css/style.css">
<script src="js/jquery-2.1.3.min.js"></script>
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
<title>親子やりとり</title>
</head>

<body>

<!-- コンテンツ表示画面 -->

<div>
    <div id="clock"></div>
    <div> なまえ：<input type="text" id="uname"> </div>
    <div>
        <textarea id="text" cols="30" rows="10"></textarea>
        <button id="send">おくる</button>
    </div>
    <div id="output" style="overflow: auto; height: 300px;"></div>
</div>
<!--/ コンテンツ表示画面 -->



<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->

<script>
    function updateClock() {
        const now = new Date();
        const month = (now.getMonth() + 1).toString().padStart(2, '0'); // 月を取得 (0始まりなので +1)
        const day = now.getDate().toString().padStart(2, '0'); // 日を取得
        const hours = now.getHours().toString().padStart(2, '0'); // 時を取得
        const minutes = now.getMinutes().toString().padStart(2, '0'); // 分を取得
        
        // 表示用の文字列を作成
        const timeString = `${month}/${day} ${hours}:${minutes}`;
        
        // 時計の表示を更新
        document.getElementById('clock').textContent = timeString;
    }

    // 初期表示
    updateClock();
    // 1分ごとに現在時刻を更新
    setInterval(updateClock, 60000); // 60000ミリ秒 = 1分
</script>



<!--** 以下Firebase **-->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, push, set, update, onChildAdded, remove, onChildChanged, onChildRemoved, } 
    from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAvCqy0m6B9654R55tjBkkDq2Gpy7Tlp_U",
      authDomain: "sample-ed045.firebaseapp.com",
      projectId: "sample-ed045",
      storageBucket: "sample-ed045.appspot.com",
      messagingSenderId: "1059501574921",
      appId: "1:1059501574921:web:5fabf973ffcf8f42e061d8"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db= getDatabase(app);
    const dbRef = ref(db, "chat")
    // const dbRef = ref(db, "chat/memo999")


    // 送信
    $("#send").on("click", function(){
        const msg = {
            uname : $("#uname").val(),
            text : $("#text").val()
            // timestamp: new Date().toLocaleString() // 現在の日時を追加   

        };
        // console.log(msg);
        const newPostRef = push(dbRef);//ユニークキーを与える
        // console.log(newPostRef);
        set(newPostRef,msg);
        // set(dbRef,msg);


        // const uname = $("#uname").val();
        // const text = $("#text").val();
        // alert(uname + text);//取得確認
    });
  
// 最初にデータ取得＆onSnapshotでリアルタイムにデータを取得
onChildAdded(dbRef, function(data){
    const msg = data.val();
    // const key = data.val();
    const key = data.key; //削除・更新に必須
    let h =  '<p id="'+key+'">'
        h += msg.uname;
        h += '<br>'
        h += '<span contentEditable="true" id="'+key+'_update">'+msg.text+'</span>'
        h += '<img class="remove" data-key="'+key+'" src="img/delete.png" style="cursor:pointer; width:30px; height:30px;"/>';
        h += '<img class="update" data-key="'+key+'" src="img/update.png" style="cursor:pointer; width:30px; height:30px;"/>';
        h += '</p>'
        $("#output").prepend(h); 
        // $("#output").append(h); //outputの最後に追加
})

// 削除イベント
$("#output").on("click",".remove", function(){
    const key = $(this).attr("data-key");
    const remove_item = ref(db,"chat/"+key);
    remove(remove_item); //Firebaseデータ削除関数
})

// 更新イベント
$("#output").on("click",".update", function(){
    const key = $(this).attr("data-key");
    update(ref(db,"chat/"+key),{
        text: $("#"+key+'_update').html()
    });
})


// 削除処理がFirebase側で実行されたらイベント発生！
onChildRemoved(dbRef,(data) => {
    $('#'+data.key).remove(); //DOM操作関数（対象を削除）
})

// 更新処理がFirebase側で実行されたらイベント発生！
onChildChanged(dbRef, (data) => {
     $('#'+data.key+'_update').html(data.val().text); 
     $('#'+data.key+'_update').fadeOut(800).fadeIn(800); 
});

  </script>





</body>
</html>
































